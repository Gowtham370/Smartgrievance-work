<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Raise a Complaint</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
    #map {
      height: 350px;
      border-radius: 0.5rem;
    }
    #preview {
      width: 100%;
      max-height: 250px;
      object-fit: cover;
      border-radius: 0.5rem;
    }
  </style>
</head>
<body class="bg-light">

  <div class="container py-5">
    <h2 class="text-center text-primary fw-bold mb-4">Raise a Complaint</h2>

    <div class="card shadow-sm border-0 rounded-4 p-4">
      <div class="row g-4 align-items-start justify-content-center">

        <!-- Left: Form -->
        <div class="col-md-6">
          <form id="complaintForm" class="needs-validation" novalidate>
            
            <!-- Upload Image -->
            <div class="mb-3">
              <label for="photoInput" class="form-label fw-semibold">Upload Image</label>
              <input type="file" id="photoInput" accept="image/*" class="form-control mb-2" required />
              <img id="preview" src="" alt="Preview" class="d-none mb-2 img-fluid" />
            </div>

            <!-- Short Description -->
            <div class="mb-3">
              <label for="description" class="form-label fw-semibold">Short Description</label>
              <textarea id="description" class="form-control" rows="2" placeholder="Write a short description..." style="resize: none;"></textarea>
            </div>

            <!-- Manual or Auto Location Input -->
            <div class="mb-3">
              <label for="manualLocation" class="form-label fw-semibold">Location</label>
              <input type="text" id="manualLocation" class="form-control" placeholder="Your location" required />
              <div class="form-text">If location access is denied, please type it manually.</div>
            </div>

            <!-- Submit Button -->
            <div class=" mt-4">
              <button type="submit" class="btn btn-success">Submit Complaint</button>
            </div>
          </form>
        </div>

        <!-- Right: Map -->
        <div class="col-md-6">
          <div id="map" class="w-100 shadow-sm"></div>
        </div>

      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    let map, marker, typingTimeout;

    // Initialize map (default India)
    function initMap() {
      map = L.map("map").setView([20.5937, 78.9629], 5);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
      }).addTo(map);

      // Click on map â†’ place marker + get address
      map.on("click", (e) => {
        const { lat, lng } = e.latlng;
        showMarker(lat, lng);
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
          .then((res) => res.json())
          .then((data) => {
            const address = data.display_name || `${lat}, ${lng}`;
            document.getElementById("manualLocation").value = address;
          });
      });
    }

    // Get user location
    function getUserLocation() {
      if (!navigator.geolocation) {
        alert("Geolocation not supported. Please enter location manually.");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude: lat, longitude: lng } = pos.coords;
          fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
            .then((res) => res.json())
            .then((data) => {
              const address = data.display_name || "Unknown location";
              document.getElementById("manualLocation").value = address;
              showMarker(lat, lng, "ðŸ“ Your Location");
            });
        },
        () => alert("âš ï¸ Location access denied. Please enter it manually."),
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }

    // Show marker on map
    function showMarker(lat, lng, popupText = "") {
      if (!marker) {
        marker = L.marker([lat, lng]).addTo(map);
      } else {
        marker.setLatLng([lat, lng]);
      }
      if (popupText) marker.bindPopup(popupText).openPopup();
      map.setView([lat, lng], 14);
    }

    // Typing location â†’ search map
    document.getElementById("manualLocation").addEventListener("input", async (e) => {
      const text = e.target.value.trim();
      if (text.length < 3) return;
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(async () => {
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(text)}`);
          const data = await res.json();
          if (data.length > 0) {
            const { lat, lon, display_name } = data[0];
            showMarker(lat, lon, display_name);
          }
        } catch (err) {
          console.error(err);
        }
      }, 600);
    });

    // Image preview + location auto-detect
    document.getElementById("photoInput").addEventListener("change", (e) => {
      const file = e.target.files[0];
      const preview = document.getElementById("preview");
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          preview.src = ev.target.result;
          preview.classList.remove("d-none");
        };
        reader.readAsDataURL(file);
        getUserLocation();
      }
    });

    // Submit form
    document.getElementById("complaintForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const location = document.getElementById("manualLocation").value.trim();
      if (!location) return alert("Please provide a location.");
      alert("âœ… Complaint submitted successfully!");
      const savedLocation = location;
      e.target.reset();
      document.getElementById("preview").classList.add("d-none");
      document.getElementById("manualLocation").value = savedLocation;
    });

    window.onload = initMap;
  </script>
</body>
</html>
